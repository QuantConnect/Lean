# Implementation Plan: ThetaData Corporate Actions Integration

## Problem
- ThetaData returns **unadjusted** historical prices
- LEAN's split/dividend handling requires factor files
- No factor files exist for ThetaData symbols → splits not applied
- UVIX 1:10 reverse split on Jan 15, 2025 caused artificial 900%+ returns

## Key Insight from ThetaData API
- Split API returns `split_date`, `old_shares`, `new_shares`, `date`
- Dividend API returns `ex_dividend_date`, `amount`, etc.
- **Caveat**: Data is returned BEFORE the event date occurs
- Must check `split_date == current_backtest_date` before applying

## Proposed Solution: Custom `IFactorFileProvider`

Create `ThetaDataFactorFileProvider` that:
1. Queries ThetaData corporate actions API for the requested symbol
2. Builds a `CorporateFactorProvider` from splits/dividends data
3. Returns it to LEAN's existing `SplitEventProvider` and `DividendEventProvider`

### Why This Approach
- No changes to core LEAN split/dividend handling
- Existing `SplitEventProvider.GetEvents()` and `DividendEventProvider.GetEvents()` continue working
- They call `FactorFile.HasSplitEventOnNextTradingDay()` which uses our ThetaData-sourced data
- Proper handling of the "data before event" caveat through factor file date logic

## Files to Create

### 1. `DataSource/CascadeThetaData/ThetaDataFactorFileProvider.cs`

Implements `IFactorFileProvider`:
- `Get(Symbol symbol)` → queries ThetaData, builds and returns `CorporateFactorProvider`
- Caches results to avoid repeated API calls
- Queries splits via `/hist/stock/split` endpoint
- Queries dividends via `/hist/stock/dividend` endpoint

### 2. `DataSource/CascadeThetaData/Models/CorporateActionsModels.cs`

Response models for ThetaData corporate actions:
- `SplitData`: `SplitDate`, `OldShares`, `NewShares`
- `DividendData`: `ExDividendDate`, `Amount`

### 3. Update `CascadeThetaDataRestClient.cs`

Add methods:
- `GetSplits(string symbol, DateTime startDate, DateTime endDate)`
- `GetDividends(string symbol, DateTime startDate, DateTime endDate)`

## Split Factor Calculation

ThetaData returns `old_shares`, `new_shares`:
- **1:10 reverse split** (10 old → 1 new): `splitFactor = new_shares/old_shares = 0.1`
- **2:1 forward split** (1 old → 2 new): `splitFactor = new_shares/old_shares = 2.0`

## Handling "Early Data" Caveat

ThetaData returns split data before `split_date`. LEAN's factor file logic handles this:
1. Build `CorporateFactorRow` with `Date = split_date - 1 trading day`
2. `HasSplitEventOnNextTradingDay(date)` detects the change
3. Split event emitted on correct date

## Implementation Order

1. Add split/dividend query methods to `CascadeThetaDataRestClient`
2. Create response models
3. Implement `ThetaDataFactorFileProvider`
4. Register provider with LEAN's Composer
5. Test with UVIX backtest
